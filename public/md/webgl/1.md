# WebGL 基础：从着色器开始

WebGL（Web Graphics Library）是在浏览器中进行硬件加速 3D 图形渲染的 JavaScript API。本文将带你深入了解 WebGL 的核心概念——着色器。

## 什么是着色器？

着色器（Shader）是运行在 GPU 上的小程序，负责处理图形渲染的各个阶段。WebGL 主要使用两种着色器：

-   **顶点着色器（Vertex Shader）**：处理顶点数据
-   **片段着色器（Fragment Shader）**：处理像素颜色

## WebGL 渲染管线

理解 WebGL 渲染管线对于掌握着色器编程至关重要：

```
顶点数据 → 顶点着色器 → 图元装配 → 光栅化 → 片段着色器 → 像素输出
```

## 创建基础的着色器程序

### 顶点着色器

```glsl
// 顶点着色器源码
attribute vec2 a_position;
attribute vec2 a_texCoord;

varying vec2 v_texCoord;

void main() {
  // 设置顶点位置
  gl_Position = vec4(a_position, 0.0, 1.0);

  // 传递纹理坐标到片段着色器
  v_texCoord = a_texCoord;
}
```

### 片段着色器

```glsl
// 片段着色器源码
precision mediump float;

varying vec2 v_texCoord;
uniform sampler2D u_texture;
uniform float u_time;

void main() {
  // 基础纹理采样
  vec4 color = texture2D(u_texture, v_texCoord);

  // 添加时间相关的效果
  float wave = sin(u_time + v_texCoord.x * 10.0) * 0.1;
  color.rgb += wave;

  gl_FragColor = color;
}
```

## JavaScript 中的着色器编译

```javascript
// 创建并编译着色器
function createShader(gl, type, source) {
    const shader = gl.createShader(type);
    gl.shaderSource(shader, source);
    gl.compileShader(shader);

    // 检查编译错误
    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
        console.error("着色器编译错误:", gl.getShaderInfoLog(shader));
        gl.deleteShader(shader);
        return null;
    }

    return shader;
}

// 创建着色器程序
function createShaderProgram(gl, vertexShaderSource, fragmentShaderSource) {
    const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
    const fragmentShader = createShader(
        gl,
        gl.FRAGMENT_SHADER,
        fragmentShaderSource
    );

    const program = gl.createProgram();
    gl.attachShader(program, vertexShader);
    gl.attachShader(program, fragmentShader);
    gl.linkProgram(program);

    // 检查链接错误
    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
        console.error("程序链接错误:", gl.getProgramInfoLog(program));
        gl.deleteProgram(program);
        return null;
    }

    return program;
}
```

## 设置顶点数据

```javascript
// 创建顶点缓冲区
function setupVertexBuffer(gl, data) {
    const buffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(data), gl.STATIC_DRAW);
    return buffer;
}

// 矩形顶点数据（位置 + 纹理坐标）
const vertices = [
    // 位置      纹理坐标
    -1.0, -1.0, 0.0, 0.0, 1.0, -1.0, 1.0, 0.0, -1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0,
    1.0,
];

// 设置属性指针
function setupAttributes(gl, program) {
    const positionLocation = gl.getAttribLocation(program, "a_position");
    const texCoordLocation = gl.getAttribLocation(program, "a_texCoord");

    const stride = 4 * 4; // 4 个浮点数，每个 4 字节

    // 位置属性
    gl.enableVertexAttribArray(positionLocation);
    gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, stride, 0);

    // 纹理坐标属性
    gl.enableVertexAttribArray(texCoordLocation);
    gl.vertexAttribPointer(texCoordLocation, 2, gl.FLOAT, false, stride, 2 * 4);
}
```

## 设置 Uniform 变量

```javascript
// 获取 uniform 位置
const timeLocation = gl.getUniformLocation(program, "u_time");
const textureLocation = gl.getUniformLocation(program, "u_texture");

// 渲染循环
function render(time) {
    // 清除画布
    gl.clearColor(0.0, 0.0, 0.0, 1.0);
    gl.clear(gl.COLOR_BUFFER_BIT);

    // 使用着色器程序
    gl.useProgram(program);

    // 设置 uniform 值
    gl.uniform1f(timeLocation, time * 0.001); // 时间（秒）
    gl.uniform1i(textureLocation, 0); // 纹理单元 0

    // 绘制
    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

    requestAnimationFrame(render);
}
```

## 完整示例

将以上代码组合起来，创建一个完整的 WebGL 应用：

```javascript
// 初始化 WebGL 上下文
const canvas = document.getElementById("canvas");
const gl = canvas.getContext("webgl");

if (!gl) {
    console.error("WebGL 不受支持");
}

// 编译着色器和程序
const program = createShaderProgram(
    gl,
    vertexShaderSource,
    fragmentShaderSource
);

// 设置顶点数据
const vertexBuffer = setupVertexBuffer(gl, vertices);
setupAttributes(gl, program);

// 开始渲染
render(0);
```

## 小结

通过本文，你学习了：

1. **着色器基础概念** - 顶点着色器和片段着色器
2. **GLSL 语法** - 着色器编程语言
3. **着色器编译** - 在 JavaScript 中编译和使用着色器
4. **顶点数据处理** - 如何传递数据到着色器
5. **Uniform 变量** - 如何传递全局参数

这是 WebGL 编程的基础，掌握这些概念后就可以创建更复杂的 3D 效果了。
